var rafeeApp=function(){var a="rafeeApp",b={module:angular.module(a,["restangular","ui.router","ngMaterial"]),applications:{},moduleName:a,isBlockingUI:function(a){return!1},baseBackendURL:"/",registerApplication:function(a,c){b.applications[a]=c},laodRest:function(){var a=0;angular.forEach(b.applications,function(c,d){c.urlPrefix&&b.module.factory(d+"RestService",["Restangular","$rootScope",function(b,d){return b.withConfig(function(b){b.setBaseUrl("/"+c.urlPrefix),b.addFullRequestInterceptor(function(a,b,c,d,e,f,g){return"auth-token"!=c?(e["Content-Type"]="application/json",{element:a,headers:rafeeApp.AuthService?rafeeApp.AuthService.updateHeadrs(e):e,params:f,httpConfig:g}):void 0}),b.addRequestInterceptor(function(b,c,e,f,g,h,i){rafeeApp.isBlockingUI(f)&&a++,d.showLoadingOverlay=a>0}),b.addResponseInterceptor(function(b,c,e,f,g,h){return rafeeApp.isBlockingUI(f)&&a--,0>a&&(a=0),d.showLoadingOverlay=a>0,b}),b.setErrorInterceptor(function(b,c){if(401==b.status)rafeeApp.AuthService&&rafeeApp.AuthService.logOut(!0);else{b&&b.data&&b.data.detail?b.data.detail:"Server error"}rafeeApp.isBlockingUI(b.config.url)&&a--,0>a&&(a=0),d.showLoadingOverlay=a>0}),c.restCongig&&c.restCongig(b)})}])})}};return b}();rafeeApp.module.config(["$stateProvider","$urlRouterProvider","RestangularProvider","$compileProvider","$httpProvider",function(a,b,c,d,e){e.defaults.cache=!1,e.defaults.headers.get||(e.defaults.headers.get={}),e.defaults.headers.get["If-Modified-Since"]="0",c.setBaseUrl(rafeeApp.baseBackendURL),c.setResponseExtractor(function(a,b){var c=a;return"getList"===b&&(angular.isArray(c)||(c=a.data)),c}),b.when("","/"),b.otherwise("/");var f=[];f.push({name:"login",url:"/login",views:{"main@":{templateUrl:"views/login.html"}}}),f.push({name:"logout",url:"/logout",views:{controller:["AuthService",function(a){a.logOut(!0)}],"main@":{templateUrl:"views/login.html"}}}),f.push({name:"home",url:"/",views:{"main@":{templateUrl:"views/core/home.html"}}}),angular.forEach(f,function(b){a.state(b)}),d.aHrefSanitizationWhitelist(/^\s*(https?|blob|):/)}]),rafeeApp.module.run(["$state","Restangular","$rootScope","AuthService","$timeout","$location",function(a,b,c,d,e,f){b.setErrorInterceptor(function(a,b){if(401==a.status)rafeeApp.AuthService&&rafeeApp.AuthService.logOut(!0);else{a&&a.data&&a.data.detail?a.data.detail:"Server error"}}),c.$on("$stateChangeStart",function(b,f,g,h,i){e(function(){"login"!=f.name?(f.name&&(window.sessionStorage.setItem("appNextStateName",f.name),g&&window.sessionStorage.setItem("appNextStateParams",angular.toJson(g))),d.isAuthenticated()?(c.logedIn=!0,"currentApp"!=f.name||rafeeApp.applications[g.application]||(c.$broadcast("$stateChangeError"),b.preventDefault(),a.go("pageNotFound"))):(c.$broadcast("$stateChangeError"),b.preventDefault(),a.go("login"))):d.isAuthenticated()&&(c.logedIn=!0,c.$broadcast("$stateChangeError"),b.preventDefault(),a.go("home"))})}),b.addFullRequestInterceptor(function(a,b,c,e,f,g,h){return f["Content-Type"]="application/json",{element:a,headers:d.updateHeadrs(f),params:g,httpConfig:h}})}]),rafeeApp.laodRest(),rafeeApp.module.service("AuthService",["Restangular","$state","$rootScope","$location","$timeout",function(a,b,c,d,e){rafeeApp.AuthService=this,this.isAuthenticated=function(a){this.updateActivity(a);var b=window.sessionStorage.getItem("loggedInUserToken");return!!b},this.getLogedinUsername=function(){return window.sessionStorage.getItem("loggedInUserName")};var f=this;this.authenticate=function(c,d,e,g){a.all("api/v1/auth-token").post({username:c,password:d},{},{"Cache-Control":"no-cache, no-store, must-revalidate"}).then(function(a){if(!a.token)return void f.logOut();window.sessionStorage.setItem("loggedInUserToken",a.token),window.sessionStorage.setItem("loggedInUserName",c);var d=(new Date).getTime();if(window.sessionStorage.setItem("LastActivity",d),e){var g=window.sessionStorage.getItem("appNextStateName"),h=window.sessionStorage.getItem("appNextStateParams");g?b.go(g,angular.fromJson(h)):b.go("home")}},function(a){alert(JSON.stringify(a)),g&&g(a)})},this.logOut=function(a){window.sessionStorage.removeItem("loggedInUserToken"),window.sessionStorage.removeItem("loggedInUserName"),window.sessionStorage.removeItem("LastActivity"),c.logedIn=!1,rafeeApp.isDataLoaded=!1,a&&b.go("login")},this.updateHeadrs=function(a,b){var c=window.sessionStorage.getItem("loggedInUserToken");if(this.updateActivity(b))return a.Authorization="JWT "+c,a["Cache-Control"]="no-cache, no-store, must-revalidate",a},this.updateActivity=function(a){var b=(new Date).getTime();window.sessionStorage.getItem("LastActivity");return a?void 0:(window.sessionStorage.setItem("LastActivity",b),!0)}}]),angular.module(rafeeApp.moduleName).controller("AdminCtrl",["$scope","Restangular",function(a,b){b.all("api/v1/slideshows/").getList().then(function(b){a.slideshows=b,a.selectModel=b.length>0?b[0]:null})}]),angular.module(rafeeApp.moduleName).controller("BaseCtrl",["$scope",function(a){}]),angular.module(rafeeApp.moduleName).controller("LoginCtrl",["$scope","AuthService",function(a,b){a.userName="",a.password="",a.doLogin=function(){a.loginErrorMessage="",b.authenticate(a.userName,a.password,!0,function(b){if(400==b.status){a.loginErrorMessage="";var c=[];if(b.data)for(var d in b.data){var e=b.data[d];if(e&&e.length>0)for(var f=0;f<e.length;f++)c.push(e[f])}0==c?a.loginErrorMessage="Server error!":a.loginErrorMessage=c.join(", ")}else a.loginErrorMessage="Server error!"})}}]),angular.module(rafeeApp.moduleName).controller("HomeCtrl",["$scope","Restangular",function(a,b){b.all("api/v1/slideshows/").getList().then(function(b){a.slideshows=b,a.selectModel=b.length>0?b[0]:null})}]);